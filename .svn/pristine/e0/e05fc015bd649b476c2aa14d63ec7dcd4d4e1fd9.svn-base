using System;
using System.Collections.Generic;
using System.Linq;
using System.Text;
using PureMVC.Interfaces;
using PureMVC.Patterns;
using UnityEngine;
using UnityEngine.UI;
using System.Collections;
using System.Timers;
using Platform.Net;
using Platform.Model;
public class GradeMediator : Mediator, IMediator
{
    //private ArrayList gradeList;
    public GradeMediator(string NAME, object viewComponent) : base(NAME, viewComponent)
    {
        //this.gradeList = new ArrayList();
    }
    public GradeView View
    {
        get
        {
            return (GradeView)ViewComponent;
        }
        
    }
    public override IList<string> ListNotificationInterests()
    {
        IList<string> list = new List<string>();
        list.Add(NotificationConstant.MEDI_HALL_GRADEADDEVENT);
        list.Add(NotificationConstant.MEDI_HALL_GETGRADEINFO);
        list.Add(NotificationConstant.MEDI_HALL_INITGRADEINFO);
        list.Add(NotificationConstant.MEDI_HALL_GETROUNDINFO);
        list.Add(NotificationConstant.MEDI_HALL_PARTICEVENT);
        return list;
    }
    public override void HandleNotification(INotification notification)
    {
        switch (notification.Name)
        {
            case NotificationConstant.MEDI_HALL_GRADEADDEVENT:
                //GradeScrollView gradeScrollView = notification.Body as GradeScrollView;
                //if (!gradeScrollView.IsInit)
                //{
                //    this.View.ButtonAddListening(gradeScrollView.SelectButton, RecourdButtonEvent,false, gradeScrollView);
                //    gradeScrollView.IsInit = true;
                //    this.View.GradeScrollList.Add(gradeScrollView);
                //}
                break;
            case NotificationConstant.MEDI_HALL_GETGRADEINFO:
                this.SendGetGrade();
                break;
            case NotificationConstant.MEDI_HALL_INITGRADEINFO:
                this.InitGradeInfo(notification.Body);
                break;
            case NotificationConstant.MEDI_HALL_GETROUNDINFO:
                this.InifRoundInfo(notification.Body);
                break;
            case NotificationConstant.MEDI_HALL_PARTICEVENT:
                ParticularsScrollView particularsScrollView = notification.Body as ParticularsScrollView;
                //if (!particularsScrollView.IsInit)
                //{
                //    this.View.ButtonAddListening(particularsScrollView.PlaybackButton,SendPlayback,false, particularsScrollView);
                //    particularsScrollView.IsInit = true;
                //    this.View.ParticularsScrollList.Add(particularsScrollView);
                //}
                break;
            default:
                break;
        }
    }
    public override void OnRegister()
    {
        base.OnRegister();
        this.View.CloseButton = this.View.ViewRoot.transform.FindChild("CloseButton").GetComponent<Button>();
        this.View.ButtonAddListening(this.View.CloseButton,
            () =>
            {
                UIManager.Instance.HideUI(UIViewID.GRADE_VIEW);
            });
    }
    public override void OnRemove()
    {
        base.OnRemove();
        UIManager.Instance.DestroyUI(UIViewID.GRADE_VIEW);
    }

    //模拟获取战绩数据
    private void SendGetGrade()
    {
        GetGradeInfoC2S package = new GetGradeInfoC2S();
        NetMgr.Instance.SendBuff<GetGradeInfoC2S>(SocketType.HALL, MsgNoC2S.REQUEST_GETGRADEINFO_C2S.GetHashCode(),0,package);
    }

    /// <summary>
    /// 绑定回调按钮
    /// </summary>
    /// <param name="param"></param>
    private void RecourdButtonEvent(object[] param)
    {
        //this.View.RecordScrollView.SetActive(false);
        //this.View.ParticularsScrollView.SetActive(true);
        //GetRoundInfoC2S package = new GetRoundInfoC2S();
        //GradeScrollView data = (GradeScrollView)param[0];
        //package.roomID = data.RoomID;
        //NetMgr.Instance.SendBuff<GetRoundInfoC2S>(SocketType.HALL, MsgNoC2S.REQUEST_GETROUNDINFOC_C2S.GetHashCode(), 0, package);
    }
    /// <summary>
    /// 初始化战绩数据
    /// </summary>
    /// <param name="body"></param>
    private void InitGradeInfo(object body)
    {
        ArrayList gradeList = new ArrayList();
        GetGradeInfoS2C package = (GetGradeInfoS2C)body;
        
        for (int i = 0; i < package.gradeDataS2C.Count; i++)
        {
            GradeDataS2C gradeInfo = package.gradeDataS2C[i];
            gradeList.Add(gradeInfo);
        }
        this.View.ParticularsTableView.DataProvider = gradeList;
    }
    /// <summary>
    /// 初始化战绩房间数据
    /// </summary>
    /// <param name="body"></param>
    private void InifRoundInfo(object body)
    {
        ArrayList roundList = new ArrayList();
        GetRoundInfoS2C package = (GetRoundInfoS2C)body;
        for (int i = 0;i < package.roundData.Count;i++)
        {
            RoundData roundData = package.roundData[i];
            roundList.Add(new ParticularsScrollData(i + 1,roundData.roomID,roundData.roomCode,roundData.time,roundData.usersInfo));
        }
        this.View.ParticularsTableView.DataProvider = roundList;
    }
    /// <summary>
    /// 回放按钮
    /// </summary>
    /// <param name="body"></param>
    private void SendPlayback(object[] param)
    {
        ParticularsScrollView particularsScrollView = (ParticularsScrollView)param[0];
        PlayVideoC2S package = new PlayVideoC2S();
        //package.round = particularsScrollView.ParticularsScrollData.ScrollID;
        //package.roomId = particularsScrollView.ParticularsScrollData.RoomID;
        //NetMgr.Instance.SendBuff<PlayVideoC2S>(SocketType.HALL, MsgNoC2S.REQUEST_PLAYVIDEO_C2S.GetHashCode(),0,package);
        //Debug.Log(particularsScrollView.ParticularsScrollData.ScrollID);
        //Debug.Log(particularsScrollView.ParticularsScrollData.RoomID);
    }
}